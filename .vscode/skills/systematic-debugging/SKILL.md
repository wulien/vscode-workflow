---
name: systematic-debugging
description: 当遇到 Bug、测试失败或任何异常行为时使用。四阶段系统化根因分析流程。
---

# 系统化调试 Skill

## 概述

**永远找根因，永远不修症状。** 四阶段系统化流程。

## The Iron Law

```
在找到根因之前，不要尝试修复。
猜测不是调试。
```

## 四阶段流程

```
Phase 1: 根因调查 — 收集证据
    ↓
Phase 2: 模式分析 — 找到模式
    ↓
Phase 3: 假设验证 — 测试假设
    ↓
Phase 4: 实现修复 — TDD 修复
```

### Phase 1: 根因调查

**收集证据，不要猜测：**

1. **精确重现问题**
   - 记录重现步骤
   - 确认可以稳定重现
   - 简化到最小重现

2. **阅读实际的错误信息**
   - 完整的错误堆栈
   - 相关日志
   - 不要跳过任何"看似无关"的信息

3. **检查近期变更**
   ```bash
   git log --oneline -10
   git diff HEAD~3  # 最近 3 个提交的变更
   ```

4. **验证假设**
   - 不要假设你知道原因
   - 添加日志/断点确认

### Phase 2: 模式分析

**在修复之前找到模式：**

1. **找到类似的正常工作的代码**
   - 同项目里类似的功能
   - 什么是能正常工作的？

2. **对比差异**
   - 正常的和异常的有什么不同？
   - 列出所有差异，无论多小

3. **理解依赖**
   - 这个组件依赖什么？
   - 什么配置/环境/前置条件？

### Phase 3: 假设验证

**先验证，后行动：**

1. **形成一个假设** — "我认为问题是因为 X"
2. **设计验证实验** — "如果我做 Y，应该看到 Z"
3. **执行实验** — 运行实验
4. **分析结果** — 假设验证了吗？

**如果假设错误：** 回到 Phase 1，不要再猜。

### Phase 4: 实现修复

**使用 TDD 修复：**

1. **编写失败的测试** — 重现 Bug 的测试
2. **运行测试确认失败** — 确认测试捕获了问题
3. **实现修复** — 最小的变更修复根因
4. **运行测试确认通过** — 确认修复有效
5. **运行所有测试** — 确认没有回归
6. **提交**

## 红旗信号 — 停下来

当你发现自己在做以下事情时，**停下来，回到 Phase 1**：

- 同时修改多个文件试图 "修复"
- 说 "应该可以了" 但没有运行验证
- 第三次尝试不同的 "修复"
- 添加 workaround 而不是找根因
- 急于提交 "应该能工作" 的代码

## 辅助技术

### 根因追踪

从症状反向追踪调用链：

```
症状: X 出错了
↓ 什么代码直接导致了这个？
↓ 谁调用了这个代码？
↓ 传入了什么参数？
↓ 这些参数从哪来？
→ 根因: 原始触发点
```

### 防御式验证

修复后添加多层防护：

```
Layer 1: 入口验证 — 验证输入
Layer 2: 业务逻辑保护 — 关键逻辑检查
Layer 3: 环境保护 — 防止危险操作
Layer 4: 调试日志 — 记录关键信息
```

## 快速参考

| 问题 | 做法 |
|------|------|
| 不确定原因 | 添加日志，收集证据 |
| 改了但没效果 | 回到 Phase 1 |
| 修了 3 次还不行 | 停下来，质疑架构 |
| "看起来修好了" | 运行测试验证 |
| 间歇性问题 | 找到稳定重现条件 |
